<!doctype html>
<html>
	<head>

		<title>101 Concurrency</title>
		<link rel="shortcut icon" type="image/ico" Href="images/duke.png">

		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="./reveal.js/dist/reset.css">
		<link rel="stylesheet" href="./reveal.js/dist/reveal.css">
		<link rel="stylesheet" href="./reveal.js/dist/theme/white.css" id="theme">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="./reveal.js/plugin/highlight/monokai.css" id="highlight-theme">
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<section>
						<img src="images/duke-threads2.png" width="60%">
						<p>
							Detecting concurrency issues with JCStress<br />
							<small>Juan Antonio Breña Moral</small>
						</p>
					</section>
					<section>
						<p>Follow the talk from your smartphone:</p>
						<img src="images/qrcode.png" width="40%" />
					</section>
					<section>
						<p>Example repository:</p>
						<a href="https://github.com/jabrena/101-concurrency" target="_blank">
							<img src="images/github.png" width="35%">
						</a>
						<p>
							<a href="https://github.com/jabrena/101-concurrency" target="_blank">
								https://github.com/jabrena/101-concurrency
							</a>
						</p>
					</section>
				</section>
				<section>
					<section>
						<p>
						"Testing show the presence, not the absence of bugs"
						</p>
						- <a href="https://en.wikipedia.org/wiki/Edsger_W._Dijkstra" target="_blank">Edsger W. Dijkstra</a>
					</section>
					<section>
						<p>
						"Quality is never an accident. It is always the result of intelligent effort."
						</p>
						- <a href="https://en.wikipedia.org/wiki/John_Ruskin" target="_blank">John Ruskin</a>
					</section>
					<section>
						<p>
							"At the heart of <u>any reasonable definition of thread safety is the concept of
							correctness</u>. If our definition of thread safety is fuzzy, it is because we lack a clear
							definition of correctness.
							<u>Correctness means that a class conforms to its specification</u>. A good specification
							defines invariants constraining an object’s state and postconditions describing the
							effects of its operations."
						</p>
						- <a href="https://jcip.net/" target="_blank">Brian Goetz, Java Concurrency in Practice, 2006</a>
					</section>
					<section>
						<img src="images/quadrants-of-concurrency1.png" width="50%">
						<small><strong>Source:</strong>
							<a href="https://twitter.com/mariofusco/status/579664916539432960" target="_blank">
								https://twitter.com/mariofusco/status/579664916539432960
							</a>
						</small>
					</section>
					<section>
						<img src="images/quadrants-of-concurrency2.png" width="80%">
						<small><strong>Source:</strong>
							<a href="https://ericnormand.me/issues/purelyfunctional-tv-newsletter-416-why-do-we-program-in-hard-mode" target="_blank">
								https://ericnormand.me/issues/purelyfunctional-tv-newsletter-416-why-do-we-program-in-hard-mode
							</a>
						</small>
					</section>
				</section>
				<section>
					<section>
						<h2>Agenda</h2>
						<ol>
							<li>Who I am</li>
							<li>Expectations</li>
							<li>Preamble</li>
							<li>Root causes</li>
							<!-- <li>Context</li> -->
							<!-- <li>Non funcional requirements</li> -->
							<!-- <li>Concurrency models</li> -->
							<!-- <li>Concurrency concepts</li> -->
							<!-- <li>Concurrency evolution in the JVM</li> -->
							<!-- <li>Design patterns that impacts you</li> -->
							<!-- <li>Other concurrency approaches</li> -->
							<li>Tooling: JCStress</li>
							<li>The next step</li>
							<li>Takeaways</li>
							<li>References</li>
							<li>Q&A</li>
						</ol>
					</section>
				</section>
				<section>
					<section>
						<h2>Who I am</h2>
						<h3>Juan Antonio Breña Moral</h3>
						<table>
							<tr>
								<td>
									<img src="./images/jab-avatar.png" width="100%"/>
								</td>
								<td style="vertical-align: top">
									<!-- Computer Science and Engineering (B.S.) <br /> -->
									Engineering in Industrial Organization (M.S.) @ <span>ICAI</span> <br />
									Head of Developer Relations @ <span>Amadeus for developers</span> <br />
									Associate Professor @ <span>ICAI</span> <br />
									STEAM Teacher @ <span>Space Math</span> <br />
									<a target="_blank" style="text-decoration: underline;" href="https://twitter.com/juanantoniobm">@juanantoniobm</a> |
									<a target="_blank" style="text-decoration: underline;" href="https://github.com/jabrena">Github</a></li>
								</td>
							</tr>
						</table>
					</section>
				</section>
				<section>
					<section>
						<h2>Expectations</h2>
						<ul>
							<li>Generate awareness about potentials concurrency issues in your projects.</li>
							<li>Review root causes about concurrency issues.</li>
							<li>Learn how to use JCStress in your projects</li>
							<li><strike>The usage of <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/invoke/VarHandle.html" target="_blank">java.lang.invoke.VarHandle</a></strike></li>
							<li><strike><a href="https://en.wikipedia.org/wiki/Deadlock" target="_blank">Deadlocks</a> scenarios</strike></li>
						</ul>
					</section>
					<!--
					https://www.baeldung.com/java-variable-handles
					-->
				</section>
				<!--
				<section>
					<h2>Disclaimer</h2>
					<img src="images/disclaimer.png" width="30%"/>
					<p>
						<strong>Note:</strong> I am not the author of JCStress <br/>
						(<a href="https://shipilev.net/" target="_blank">Aleksey Shipilëv</a>), but I will do my best.
						<br/>😊
					</p>
				</section>
				-->
				<section>
					<section>
						<h2>Preamble</h2>
						<p>
							Imagine a development with some Business requirements:
						</p>
						<!--
						https://cucumber.io/docs/gherkin/reference/
						-->
						<pre><code data-trim>
Feature: Sum 2 numbers

  Scenario: Sum 2 positive numbers
	&nbsp;&nbsp;Given the POST endpoint /api/v1/sum2numbers
	&nbsp;&nbsp;When the client send the request
	&nbsp;&nbsp;Then the response includes the sum of the 2 parameters
						</code></pre>
					</section>
					<section>
						<h2>Preamble</h2>
						<p>
							The code has a good Unit Tests:
						</p>
						<img src="images/test-report.png" width="100%"/>
					</section>
					<section>
						<h2>Preamble</h2>
						<p>
							The code has a good Test Coverage:
						</p>
						<img src="images/jacoco-report.png" width="100%"/>
					</section>
					<section>
						<h2>Preamble</h2>
						<p>
							The code has a good Mutation Coverage:
						</p>
						<img src="images/pitest-report.png" width="100%"/>
					</section>
					<section>
						<h2>Preamble</h2>
						<ul>
							<li>The code has a good Score in Sonar.</li>
							<li>The code doesn´t have any Memory leak.</li>
							<li>The code has a good Throughput.</li>
							<li>The code has a good Pipeline support.</li>
						</ul>
					</section>
					<section>
						<h2>Preamble</h2>
						<p>
							But..., one day we receive an email from one User about unexpected results...
						</p>
						<img src="images/email.png" width="40%" />
					</section>
					<section>
						<h2>Preamble</h2>
						<img src="images/thinking1.jpg" width="50%" />
						<p>
							<strong>Developer:</strong> "Weird, everything is fine in my side..."
						</p>
					</section>
					<section>
						<h2>Preamble</h2>
						<img src="images/thinking3.png" width="40%" />
						<p>
							<strong>Developer:</strong> "...and using the data provided from the User,
							the new test doesn´t reproduce the issue in my local dev environment."
						</p>
					</section>
					<section>
						<h2>Preamble</h2>
						<img src="images/thinking6.png" width="30%" />
						<p>
							<strong>Developer:</strong> "...maybe, I didn´t read the <a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-17.html" target="_blank">JLS (Java Language Specification), section 17.4.</a> about <u>Concurrency</u>
							and the <a href="https://download.oracle.com/otndocs/jcp/memory_model-1.0-pfd-spec-oth-JSpec/" target="_blank">JSR-133 Java Memory Model and Thread Specification</a>"
						</p>
					</section>
					<section>
						<h2>Preamble</h2>
						<img src="images/thinking5.png" width="35%" />
						<p>
							<strong>Developer:</strong> "...but now, we are in Production..."
						</p>
					</section>
					<section>
						<h2>Preamble</h2>
						<hr />
						<h3 style="color:green">
							Java is a multithreading & multiprocessing programming language
							and <u>Shared Memory</u> is the Inter-Process Communication (IPC) technique for Threads.
						</h3>
						<hr />
						<p>
							And <u>every Java developer needs to know it</u>.
						</p>
					</section>
				</section>
				<!--
				<section>
					<section>
						<h2>Root causes</h2>
						<p>But..</p>
						<p>
							What do you think about possible root causes to generate Concurrency issues?
						</p>
						<img src="images/concurrency-issues.jpg" width="40%"/>
					</section>
					<section>
						<img src="images/survey.png"/>
					</section>
					<section>
						<p>
							<a href="https://pollev.com/juanantoniobrenamoral114" target="_blank">https://pollev.com/juanantoniobrenamoral114</a>
						</p>
					</section>
					<section>
						<h2>Root causes</h2>
						<p>I share some ideas about it:</p>
					</section>
					<section>
						<h2>Root causes</h2>
						<ul>
							<li>Engineering teams bad designed.</li>
							<li>Project bad estimated.</li>
							<li>Cognitive load issues.</li>
							<li>Lack of specialists about concurrency in your BU.</li>
							<li>Poliglot environments</li>
						</ul>
					</section>
					<section>
						<h2>Root causes</h2>
						<ul>
							<li>Lack of internal trainings about concurrency.</li>
							<li>Bad delegation of complex tasks.</li>
							<li>Projects with non-functional requirements well defined.</li>
							<li>Engineers more focused on cool features from Frameworks than language fundamentals.</li>
						</ul>
					</section>
					<section>
						<h2>Root causes</h2>
						<p>
							the projects could be headed to the cliff like Lemmings:
						</p>
						<img src="images/lemmings.png" width="50%"/>
					</section>
				</section>
				-->
				<!--
				<section>
					<section>
						<h2>Context</h2>
						<ul>
							<li>In many cases, non funcional requirements are not well defined.</li>
							<li>If the team are using some kind of "Agile flavour", the definition of Done, doesnt´t define aspects about non funcional requirements.</li>
							<li>The Java programming language has included Multithreading features since 1996 (Java 1.0).</li>
						</ul>
					</section>
					<section>
						<h2>Context</h2>
						<ul>
							<li>Not all Java developers understand how to program thread-safety code.</li>
							<li>Handling shared memory is the main approach in Java but it is not the unique approach.</li>
							<li>Is it still valid the term: "Write once, run everywhere"? (When you deploy multithreading code in production).</li>
						</ul>
					</section>
					<! --
					<section>
						<img src="images/quiz.png" width="50%"/>
					</section>
					<section>
						<h2>Context</h2>
						<h4>Question: What is the java version used in production?</h4>
						<p>
							<a href="https://pollev.com/juanantoniobrenamoral114" target="_blank">https://pollev.com/juanantoniobrenamoral114</a>
						</p>
					</section>
					<section>
						<h2>Context</h2>
						<h4>Question: Did all your team members read "Concurrent Programming in Java" or "Java concurrency in practice" at least once?</h4>
						<p>
							<a href="https://pollev.com/juanantoniobrenamoral114" target="_blank">https://pollev.com/juanantoniobrenamoral114</a>
						</p>
						<img src="images/book-java-concurrency-in-practice.jpg" width="24%" />&nbsp;
						<img src="images/book-concurrent-programming-in-java.jpg" width="25%" />
					</section>
					<section>
						<h2>Context</h2>
						<h4>Question: Did you face in the past a Concurrency issue?</h4>
						<p>
							<a href="https://pollev.com/juanantoniobrenamoral114" target="_blank">https://pollev.com/juanantoniobrenamoral114</a>
						</p>
					</section>
					<section>
						<h2>Context</h2>
						<h4>Question: What kind of concurrency objects or language resources, do you use in your daily job?</h4>
						<p>
							<a href="https://pollev.com/juanantoniobrenamoral114" target="_blank">https://pollev.com/juanantoniobrenamoral114</a>
						</p>
					</section>
					-- >
				</section>
				-->
				<section>
					<section>
						<h2>Root causes</h2>
						<h4>Non funcional requirements</h4>
						<p>
							Do you define properly the non functional requirements in your projects?
						</p>
						<img src="images/iceberg.png" width="50%"/>
					</section>
					<!--
					<section>
						<h2>Root causes</h2>
						<h4>Non funcional requirements</h4>
						<p>
							Do you know that exist an ISO Standard for Software Quality aspects?
						</p>
					</section>
					-->
					<section>
						<h2>Root causes</h2>
						<h4>Non funcional requirements</h4>
						<h5>ISO 25010</h5>
						<p>
							ISO 25010, titled “System and software quality models”, is a software quality standard.
							It describes the models, consisting of characteristics and sub-characteristics,
							for both software product quality, and software quality in use together with practical
							guidance on the use of the quality models.
						</p>
						<small><strong>Source:</strong>
							<a href="https://iso25000.com/index.php/en/iso-25000-standards/iso-25010" target="_blank">
								https://iso25000.com/index.php/en/iso-25000-standards/iso-25010</a>
						</small>
					</section>
					<section>
						<h2>Root causes</h2>
						<h4>Non funcional requirements</h4>
						<h5>ISO 25010</h5>
						<img src="images/iso-25010.png" />
						<br />
						<small><strong>Source:</strong>
							<a href="https://iso25000.com/index.php/en/iso-25000-standards/iso-25010" target="_blank">
								https://iso25000.com/index.php/en/iso-25000-standards/iso-25010</a>
						</small>
					</section>
					<!--
					<section>
						<h2>Root causes</h2>
						<h4>Non funcional requirements</h4>
						<h5>ISO 25010</h5>
						<ul>
							<li>Functional Suitability</li>
							<li>Performance efficiency</li>
							<li>Compatibility</li>
							<li>Usability</li>
							<li>Reliability</li>
							<li>Security</li>
							<li>Maintainability</li>
							<li>Portability</li>
						</ul>
					</section>
					-->
					<!--
					<section>
						<h2>Root causes</h2>
						<h4>Non funcional requirements</h4>
						<h5>ISO 25010</h5>
						<strong>Functional Suitability</strong>
						<p>
						This characteristic represents the degree to which a product or system provides functions
						that meet stated and implied needs when used under specified conditions.
						</p>
					</section>
					<section>
						<h2>Root causes</h2>
						<h4>Non funcional requirements</h4>
						<h5>ISO 25010</h5>
						<strong>Functional Suitability</strong>
						<p>
							This characteristic is composed of the following sub-characteristics:
						</p>
						<small>
							<ul>
								<li>Functional completeness - Degree to which the set of functions covers all the specified tasks and user objectives.</li>
								<li><u>Functional correctness - Degree to which a product or system provides the correct results with the needed degree of precision.</u></li>
								<li>Functional appropriateness - Degree to which the functions facilitate the accomplishment of specified tasks and objectives.</li>
							</ul>
						</small>
					</section>
					-->
					<!--
					<section>
						<h2>Root causes</h2>
						<p>
							"At the heart of any reasonable definition of thread safety is the concept of
							correctness. If our definition of thread safety is fuzzy, it is because we lack a clear
							definition of correctness.
							Correctness means that a class conforms to its specification. A good specification
							defines invariants constraining an object’s state and postconditions describing the
							effects of its operations."
						</p>
						- <a href="https://jcip.net/" target="_blank">Brian Goetz, Java Concurrency in Practice, 2006</a>
					</section>
					-->
				</section>
				<!--
				<section>
					<section>
						<h2>Concurrency concepts</h2>
						<ul>
							<li>Concurrency & Parallelism</li>
							<li>Amdahl's law</li>
							<li>Cache coherency</li>
							<li>JMM, Java memory model</li>
						</ul>
					</section>
					<section>
						<h2>Concurrency concepts</h2>
						<h4>Concurrency & Parallelism</h4>
						<img src="images/concurrency-parallelism.png" width="70%" />
					</section>
					<section>
						<h2>Concurrency concepts</h2>
						<h4>Amdahl's law</h4>
						<p>
							Amdahl's law is a formula which gives the theoretical speedup in latency
							of the execution of a task at fixed workload that can be expected of
							a system whose resources are improved.
							Specifically, it states that "the overall performance improvement gained by optimizing
							a single part of a system is limited by the fraction of time that the improved part
							is actually used".
						</p>
						<a href="https://en.wikipedia.org/wiki/Amdahl%27s_law" target="_blank">https://en.wikipedia.org/wiki/Amdahl%27s_law</a>
					</section>
					-->
					<!--
					http://www.cs.umd.edu/~pugh/java/memoryModel/Dagstuhl.pdf
					https://chowdera.com/2022/04/202204030513095225.html
					https://www.cs.umd.edu/~pugh/java/memoryModel/jsr133.pdf
					https://www.slideshare.net/instinctools_EE_Labs/java-memory-model-66558368
					https://shipilev.net/talks/geecon-May2018-jmm.pdf
					https://shipilev.net/blog/2014/safe-public-construction/
					https://shipilev.net/blog/2014/jmm-pragmatics/
					https://shipilev.net/talks/narnia-2555-jmm-pragmatics-en.pdf
					https://shipilev.net/blog/2016/close-encounters-of-jmm-kind/
					-->
					<!--
					<section>
						<h2>Concurrency concepts</h2>
						<h4>JMM, Java memory model</h4>
						<p>
							Defines the semantics of multithreaded programs
						</p>
						<p>
							The Java memory model describes how threads in the Java programming language
							interact through memory. Together with the description of single-threaded execution of code,
							the memory model provides the semantics of the Java programming language.
						</p>
						<a href="https://en.wikipedia.org/wiki/Java_memory_model" target="_blank">https://en.wikipedia.org/wiki/Java_memory_model</a>
					</section>
					<section>
						<h2>Concurrency concepts</h2>
						<h4>JMM, Java memory model</h4>
						<ul>
							<li>Modern hardware architecture</li>
							<li>How JVM interacts with hardware</li>
							<li>What is shared memory?</li>
						</ul>
					</section>
					<section>
						<h2>Concurrency concepts</h2>
						<h4>JMM, Java memory model</h4>
						<ul>
							<li>Atomicity:
								Which instructions must have indivisible effects.
								For purposes of the model, these rules need to be stated only for simple reads
								and writes of memory cells representing fields - instance and static variables,
								also including array elements, but not including local variables inside methods.</li>
							<li>Visibility:
								Under what conditions the effects of one thread are visible to another.
								The effects of interest here are writes to fields, as seen via reads of those fields.</li>
							<li>Ordering:
								Under what conditions the effects of operations can appear out of order
								to any given thread. The main ordering issues surround reads and writes associated
								with sequences of assignment statements.</li>

						</ul>
					</section>
					<section>
						<h2>Concurrency concepts</h2>
						<h4>JMM, Java memory model</h4>
						<img src="images/jmm-1.png" width="70%" />
					</section>
					<section>
						<h2>Concurrency concepts</h2>
						<h4>JMM, Java memory model</h4>
						<img src="images/jmm-2.png" width="70%" />
					</section>
				</section>
				-->
				<section>
					<section>
						<h2>Root causes</h2>
						<h4>Concurrency models</h4>
						<p>
							Every programming language implement different approaches about Concurrency
							and not all of them are in the same stage.
						</p>
						<p>
							That detail is important when you apply "T-shaped" strategies.
						</p>
					</section>
					<section>
						<h2>Root causes</h2>
						<h4>Concurrency models</h4>
						<img src="images/lang-rank-0122.png" width="50%">
						<br />
						<small><strong>Source:</strong>
							<a href="https://redmonk.com/sogrady/2022/03/28/language-rankings-1-22/" target="_blank">
								https://redmonk.com/sogrady/2022/03/28/language-rankings-1-22/</a>
						</small>
					</section>
					<!--
					https://www.baeldung.com/java-thread-lifecycle
					https://dzone.com/articles/java-concurrency-evolution
					-->
					<section>
						<h2>Root causes</h2>
						<h4>Concurrency models</h4>
						<p>
							How Concurrency evolves in Java:
						</p>
						<small>
							<table>
								<tr>
									<th>Java version</th>
									<th>Key features</th>
									<th>Release data</th>
								</tr>
								<tr>
									<td>Java 1.0</td>
									<td>Java OS Threads</td>
									<td>23/01/1996</td>
								</tr>
								<tr>
									<td>Java 1.5</td>
									<td>JSR 133, java.util.concurrent.*</td>
									<td>30/09/2004</td>
								</tr>
								<tr>
									<td>Java 1.7</td>
									<td>Fork/join framework</td>
									<td>07/07/2011</td>
								</tr>
								<tr>
									<td>Java 1.8</td>
									<td>CompletableFuture</td>
									<td>18/03/2014</td>
								</tr>
								<tr>
									<td>Java 19</td>
									<td>Virtual Threads, Structured Concurrency</td>
									<td>20/09/2022</td>
								</tr>
							</table>
						</small>
					</section>
					<! --
					https://en.wikipedia.org/wiki/Java_memory_model
					https://jenkov.com/tutorials/java-concurrency/java-memory-model.html
					-- >
				</section>
				<section>
					<section>
						<h2>Root causes</h2>
						<h4>Design patterns that impacts you</h4>
						<ul>
							<li>CDI, Contexts and Dependency Injection</li>
						</ul>
						<img src="images/spring-container.png" width="50%" />
					</section>
					<section>
						<h2>Root causes</h2>
						<h4>Design patterns that impacts you</h4>
						<p>
							CDI (Contexts and Dependency Injection) is a standard
							dependency injection framework included in Jakarta EE.
							It allows us to manage the lifecycle of
							stateful components via domain-specific lifecycle
							contexts and inject components (services) into client
							objects in a type-safe way.
						</p>
					</section>
				</section>
				<!--
				https://github.com/awspring/spring-cloud-aws/search?l=Java&q=%22synchronized+%28this.%22
				https://github.com/search?l=Java&q=org%3Aspring-projects+%22import+java.util.concurrent.locks.%22&type=Code
				https://github.com/search?l=Java&q=org%3Aspring-projects+%22volatile+%22&type=Code
				https://github.com/search?l=Java&q=org%3Aspring-projects+%22synchronized+%28this%22&type=Code
				https://github.com/search?l=Java&q=org%3Aquarkusio+%22volatile+%22&type=Code
				https://github.com/search?q=org%3Aquarkusio+%22synchronized+%28this%22&type=code
				https://github.com/search?q=org%3Aquarkusio+%22import+java.util.concurrent.locks.%22&type=code
				https://github.com/search?l=Java&q=org%3Amicronaut-projects+%22import+java.util.concurrent.locks.%22&type=Code
				https://github.com/search?q=org%3Amicronaut-projects+%22synchronized+%28this%22&type=code
				https://github.com/search?l=Java&q=org%3Amicronaut-projects+%22volatile+%22&type=Code
				https://github.com/search?q=org%3Areactor+jcstress&type=code
				https://github.com/reactor/reactor-core/blob/main/reactor-core/src/jcstress/java/reactor/util/concurrent/MpscLinkedQueueStressTest.java
				https://github.com/reactor/reactor-core/blob/main/reactor-core/src/test/java/reactor/util/concurrent/MpscLinkedQueueTest.java
				https://github.com/reactor/reactor-core/blob/main/reactor-core/src/main/java/reactor/util/concurrent/MpscLinkedQueue.java
				-->
				<!--
				https://foojay.io/today/jcstress/
				https://www.baeldung.com/java-testing-multithreaded#4-java-jcstress
				https://shipilev.net/talks/geecon-May2018-jmm.pdf
				https://shipilev.net/blog/2014/jmm-pragmatics/#_preface
				https://shipilev.net/talks/narnia-2555-jmm-pragmatics-en.pdf
				https://shipilev.net/blog/2016/close-encounters-of-jmm-kind/

				./gradlew clean jcstress --tests "Calculator5Test"
				-->
				<section>
					<section>
						<h2>Tooling: JCStress</h2>
						<ul>
							<li>Introduction</li>
							<!-- <li>What are the benefits?</li> -->
							<li>Creating your first JCStress test</li>
							<li>Reviewing a JCStress in detail</li>
							<li>Multithreading issues</li>
							<li>Does exist plugins?</li>
							<li>Who is using JCStress?</li>
							<li>Limitations</li>
						</ul>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Introduction</h4>
						<p>
							The Java Concurrency Stress (jcstress) is the experimental harness and
							a suite of tests to aid the research in the correctness of concurrency support
							in the JVM, class libraries, and hardware.
						</p>
						<small>
						<strong>Project: </strong><a href="https://github.com/openjdk/jcstress" target="_blank">https://github.com/openjdk/jcstress</a>
						</small>
					</section>
					<!--
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>What are the benefits?</h4>
						<ul>
							<li>Increase the capacity to test for concurrency in your Java classes
								that you know that the class is sharing state.</li>
						</ul>
					</section>
					-->
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Creating your first JCStress test</h4>
						<pre><code data-trim class="stretch">
@JCStressTest
@Outcome(id = "1, 1", expect = Expect.ACCEPTABLE_INTERESTING, desc = "Both actors came up with the same value: atomicity failure.")
@Outcome(id = "1, 2", expect = Expect.ACCEPTABLE, desc = "actor1 incremented, then actor2.")
@Outcome(id = "2, 1", expect = Expect.ACCEPTABLE, desc = "actor2 incremented, then actor1.")
@State
public class Example_01 {

	int v;

	@Actor
	public void actor1(II_Result r) {
		r.r1 = ++v; // record result from actor1 to field r1
	}
	@Actor
	public void actor2(II_Result r) {
		r.r2 = ++v; // record result from actor2 to field r2
	}
}
						</code></pre>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Creating your first JCStress test</h4>
						<p>
							How to run the test?
						</p>
						<pre><code data-trim class="stretch">
./gradlew clean jcstress --tests "Example_01"
						</code></pre>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Creating your first JCStress test</h4>
						<img src="images/demo.png" width="60%" />
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Reviewing a JCStress in detail</h4>
						<pre><code data-trim>
@JCStressTest : Annotation which allow executing the class
@Description : Test description
@Outcome : Annotation to define expected results
@State : The class annotated with state will store the object state
@Actor : The elements which run the
@Result
						</code></pre>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Reviewing a JCStress in detail</h4>
						<p>JCStress provides a solution for every Java datatype:</p>
						<small>
							<ul>
								<li>I:  int</li>
								<li>Z:  boolean</li>
								<li>F:  float</li>
								<li>J:  long</li>
								<li>S:  short</li>
								<li>B:  byte</li>
								<li>C:  char</li>
								<li>D:  double</li>
								<li>L:  object</li>
							</ul>
						</small>
						<p>
							<small>
								<strong>Source:</strong> <a href="https://docs.oracle.com/javase/tutorial/java/nutsandbolts/datatypes.html" target="_blank">Java datatypes</a>
							</small>
						</p>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Reviewing a JCStress in detail</h4>
						<pre><code data-trim class="stretch">
./gradlew clean jcstress --tests "Example_01"

[OK] info.jab.examples.Example_01.Case1

Results across all configurations:

RESULT      SAMPLES     FREQ       EXPECT  DESCRIPTION
1, 1   62,368,453   12.29%  Interesting  Both actors came up with the same value: atomicity failure.
1, 2  226,809,622   44.69%   Acceptable  actor1 incremented, then actor2.
2, 1  218,355,237   43.02%   Acceptable  actor2 incremented, then actor1.
						</code></pre>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Multithreading issues</h4>
						<p>
							Using JCStress tests, it is possible to detect
							multithreading issues about:
						</p>
						<ol>
							<li>Atomicity</li>
							<li>Visibility</li>
							<li>Reordering</li>
						</ol>
					</section>
					<!--
					https://www.javacodegeeks.com/2014/08/java-concurrency-tutorial-atomicity-and-race-conditions.html
					https://research.ibm.com/haifa/Workshops/verification2005/present/atomicity.pdf
					-->
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Multithreading issues</h4>
						<ul>
							<li>Atomicity: We say a set of actions is atomic if they all execute as a single operation, in an indivisible manner.</li>
						</ul>
						<img src="images/jmm-1.png" width="50%"/>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Multithreading issues</h4>
						<ul>
							<li>Visibility: ensuring that a change to a shared variable made by one thread is visible to the rest of the threads.</li>
						</ul>
						<img src="images/java-visibility-1.png" width="30%" />
						<small>
							<strong>Source:</strong> <a href="https://jenkov.com/tutorials/java-concurrency/volatile.html" target="_blank">https://jenkov.com/tutorials/java-concurrency/volatile.html</a>
						</small>
					</section>
					<!--
					https://jenkov.com/tutorials/java-concurrency/java-happens-before-guarantee.html
					-->
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Multithreading issues</h4>
						<ul>
							<li>Reordering / Compiler and CPU optimisations: The JVM could change the order of executions.</li>
						</ul>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Multithreading issues</h4>
						<p>
							With volatile or synchronized / explicit locks,
							you could fix the following issues:
						</p>
						<table>
							<tr>
								<th>#</th>
								<th>Atomicity</th>
								<th>Visibility</th>
								<th>Reordering</th>
							</tr>
							<tr>
								<td>volatile</td>
								<td></td>
								<td>x</td>
								<td>x</td>
							</tr>
							<tr>
								<td>synchronized / explicit locks</td>
								<td>x</td>
								<td>x</td>
								<td>x</td>
							</tr>
						</table>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Multithreading issues</h4>
						<p>
							But in Java, you several alternatives to manage the shared memory:
						</p>
						<ul>
							<li>volatile</li>
							<li>synchronized / <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/package-summary.html" target="_blank">java.util.concurrent.locks</a></li>
							<li><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/package-summary.html" target="_blank">java.util.concurrent.atomic</a></li>
							<li><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/concurrent/package-summary.html" target="_blank">java.util.concurrent.*</a>(Queues, Synchronizers, Concurrent Collections)</li>
						</ul>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Multithreading issues</h4>
						<p>
							To understand the concept, we will use JCSTress to
							review scenarios for <u>Atomicity, Visibility, Ordering</u>.
						</p>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Multithreading / Atomicity</h4>
						<p>
							Imagine that you need to use the following class in project.
							How to verify that this class is <u>Thread Safe</u>?
						</p>
						<pre><code data-trim class="stretch">
public static class AuxCase2 {

	private int v;

	public int add() {
		return ++v;
	}
}
						</code></pre>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Multithreading / Atomicity</h4>
						<p>
							Notes about Pre-Increment operator:
						</p>
						<pre><code data-trim class="stretch">
1) Post-Increment (i++):
we use i++ in our statement if we want to use the current
value, and then we want to increment the value of i by 1.

2) Pre-Increment(++i):
We use ++i in our statement if we want to increment the value of i by 1
and then use it in our statement.

Example

int i = 3;
int a = i++; // a = 3, i = 4
int b = ++a; // b = 4, a = 4
						</code></pre>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Multithreading / Atomicity</h4>
						<p>
							We will create a test:
						</p>
						<pre><code data-trim class="stretch">
@JCStressTest
@Outcome(id = "1, 1", expect = Expect.ACCEPTABLE_INTERESTING, desc = "Both actors came up with the same value: atomicity failure.")
@Outcome(id = "1, 2", expect = Expect.ACCEPTABLE, desc = "actor1 incremented, then actor2.")
@Outcome(id = "2, 1", expect = Expect.ACCEPTABLE, desc = "actor2 incremented, then actor1.")
@State
public static class Example_01 {
	AuxCase2 v = new AuxCase2();
	@Actor
	public void actor1(II_Result r) {
		r.r1 = v.add(); // record result from actor1 to field r1
	}
	@Actor
	public void actor2(II_Result r) {
		r.r2 = v.add(); // record result from actor2 to field r2
	}
}
						</code></pre>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Multithreading / Atomicity</h4>
						<p>
							Execute the test to verify it:
						</p>
						<pre><code data-trim class="stretch">
./gradlew clean jcstress --tests "Example_01"
						</code></pre>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Multithreading / Atomicity</h4>
						<p>
							Why I receive cases for: <u>@Outcome(id = "1, 1", expect = Expect.ACCEPTABLE_INTERESTING)</u>
						</p>
						<p>
							<strong>++ operator is not atomic</strong>
						</p>
						<p>
							The Pre-Increment(++i) operator execute more
							than 1 instruction being executed under the hood.
						</p>
						<p>
							++i; it is load/add/store
						</p>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Multithreading / Atomicity</h4>
						<p>
							How to fix the issue?:
						</p>
						<pre><code data-trim>
./gradlew clean jcstress --tests "Example_02"
						</code></pre>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Multithreading / Atomicity</h4>
						<img src="images/demo.png" width="60%" />
					</section>
					<!--
					https://vmlens.com/articles/ct/visibility_bugs/
					-->
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Multithreading / Visibility</h4>
						<pre><code data-trim class="stretch">
public class AuxCase5 {

	boolean flag = false;

	public void enable() {
		flag = true;
	}

	public void poll() {
		while(flag == false) {
			//Process X
		}
	}
}
						</code></pre>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Multithreading / Visibility</h4>
						<pre><code data-trim class="stretch">
@JCStressTest(Mode.Termination)
@Outcome(id = "TERMINATED", expect = Expect.ACCEPTABLE, desc = "Gracefully finished.")
@Outcome(id = "STALE", expect = Expect.ACCEPTABLE_INTERESTING, desc = "Test hung up.")
@State
public static class Example_03 {

	AuxCase5 v = new AuxCase5();

	@Actor
	public void actor1() {
		v.poll();
	}

	@Signal
	public void actor2() {
		v.enable();
	}
}
						</code></pre>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Multithreading / Visibility</h4>
						<p>
							Execute the test to verify it:
						</p>
						<pre><code data-trim class="stretch">
./gradlew clean jcstress --tests "Example_03"
						</code></pre>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Multithreading / Visibility</h4>
						<img src="images/demo.png" width="60%" />
					</section>
					<!--
					https://blog.katastros.com/a?ID=01650-44d39e31-fbb5-46d5-990e-a9563e1c2a92
					-->
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Multithreading / Ordering</h4>
						<pre><code data-trim class="stretch">
@JCStressTest
@Outcome(id = {"0, 1", "1, 0", "1, 1"}, expect = ACCEPTABLE, desc = "ok")
@Outcome(id = "0, 0", expect = ACCEPTABLE_INTERESTING, desc = "danger")
@State
public class Example_04 {

    int x, y;

    @Actor
    public void actor1(II_Result r) {
        x = 1;
        r.r2 = y;
    }

    @Actor
    public void actor2(II_Result r) {
        y = 1;
        r.r1 = x;
    }
}
						</code></pre>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Multithreading / Ordering</h4>
						<p>
							Execute the test to verify it:
						</p>
						<pre><code data-trim class="stretch">
./gradlew clean jcstress --tests "Example_04"
						</code></pre>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Multithreading / Ordering</h4>
						<img src="images/demo.png" width="60%" />
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Does exist plugins?</h4>
						<p>
							Today exist a plugin for Gradle, but not for Maven.
						</p>
						<small><strong>Source:</strong>
							<a href="https://github.com/reyerizo/jcstress-gradle-plugin" target="_blank">
								https://github.com/reyerizo/jcstress-gradle-plugin</a>
						</small>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Does exist plugins?</h4>
						<pre><code data-trim>
plugins {
    id 'io.github.reyerizo.gradle.jcstress' version '0.8.13'
}
ext {
    jcstressVersion = '0.15'
}
jcstress {
    jcstressDependency "org.openjdk.jcstress:jcstress-core:${jcstressVersion}"
    verbose = true
    timeMillis = "200"
    spinStyle = "THREAD_YIELD"
}
						</code></pre>
						<small><strong>Source:</strong>
							<a href="https://github.com/reyerizo/jcstress-gradle-plugin/blob/master/README.md" target="_blank">
								https://github.com/reyerizo/jcstress-gradle-plugin/blob/master/README.md</a>
						</small>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Who is using JCStress?</h4>
						<ul>
							<li><a href="https://github.com/openjdk" target="_blank">https://github.com/openjdk</a></li>
							<li><a href="https://github.com/adoptium/aqa-tests" target="_blank">https://github.com/adoptium/aqa-tests</a></li>
							<li><a href="https://github.com/real-logic/agrona" target="_blank">https://github.com/real-logic/agrona</a></li>
							<li><a href="https://github.com/eclipse/eclipse-collections" target="_blank">https://github.com/eclipse/eclipse-collections</a></li>
						</ul>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Who is using JCStress?</h4>
						<ul>
							<li><a href="https://github.com/reactor/reactor-core" target="_blank">https://github.com/reactor/reactor-core</a></li>
							<li><a href="https://github.com/reactor/reactor-pool" target="_blank">https://github.com/reactor/reactor-pool</a></li>
							<li><a href="https://github.com/rsocket/rsocket-java" target="_blank">https://github.com/rsocket/rsocket-java</a></li>
							<li><a href="https://github.com/LMAX-Exchange/disruptor" target="_blank">https://github.com/LMAX-Exchange/disruptor</a></li>
							<li><a href="https://github.com/resilience4j/resilience4j" target="_blank">https://github.com/resilience4j/resilience4j</a></li>
							<li><a href="https://github.com/dropwizard/metrics" target="_blank">https://github.com/dropwizard/metrics</a></li>
						</ul>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Who is using JCStress?</h4>
						<ul>
							<li><a href="https://github.com/scala/scala" target="_blank">https://github.com/scala/scala</a></li>
							<li><a href="https://github.com/sbt/sbt-jcstress" target="_blank">https://github.com/sbt/sbt-jcstress</a></li>
							<li><a href="https://github.com/zio/zio" target="_blank">https://github.com/zio/zio</a></li>
						</ul>
					</section>
					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Who is using JCStress?</h4>
						<p>
							In what stage is JCStress? (Early majority)
						</p>
						<img src="images/chasm.png" width="70%"/>
					</section>

					<section>
						<h2>Tooling: JCStress</h2>
						<h4>Limitations</h4>
						<ul>
							<li>Lack of Maven plugin</li>
							<li>Very low level tests</li>
							<li>Solution not integrated with JUnit</li>
							<li>What happen if your class has IO?</li>
						</ul>
					</section>
				</section>
				<section>
					<h2>The next step</h2>
					<p>
						Organize a session with your Dev team to review the
						<a href="https://github.com/openjdk/jcstress/tree/master/jcstress-samples/src/main/java/org/openjdk/jcstress/samples">samples</a>
						from JCStress repository:
					</p>
					<ul>
						<li><a href="https://github.com/openjdk/jcstress/tree/master/jcstress-samples/src/main/java/org/openjdk/jcstress/samples/jmm" target="_blank">jmm</a></li>
						<li><a href="https://github.com/openjdk/jcstress/tree/master/jcstress-samples/src/main/java/org/openjdk/jcstress/samples/primitives" target="_blank">primitives</a></li>
					</ul>
					<p>
					<img src="images/smart-genius.gif" width="40%"/>
					</p>
				</section>
				<section>
					<h2>Takeaways</h2>
					<ul>
						<li>Minimize the number of Beans in your projects</li>
						<li>Maximize immutability in your projects</li>
						<li>Run recurrent training about Concurrency in your Developer teams if it is necessary</li>
						<li>Improve your knowledge about Language fundamentals, not only about frameworks & libraries.</li>
						<li>Weekly, save time for learning activities in your working time.</li>
					</ul>
				</section>
				<section>
					<section>
						<h2>References</h2>
						<ul>
							<li><a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-17.html" target="_blank">Java Language Specification / Chapter 17. Threads and Locks</a></li>
							<li><a href="https://download.oracle.com/otndocs/jcp/memory_model-1.0-pfd-spec-oth-JSpec/">JSR-133 Java Memory Model and Thread Specification 1.0 Proposed Final Draft</a></li>
							<li><a href="https://openjdk.org/jeps/193" target="_blank">JEP 193: Variable Handles</a></li>
							<li><a href="http://www.cs.umd.edu/~pugh/java/memoryModel/jsr-133-faq.html" target="_blank">JSR 133 (Java Memory Model) FAQ</a></li>
							<li><a href="https://web.archive.org/web/20220601003130/http://gee.cs.oswego.edu/dl/jmm/cookbook.html" target="_blank">The JSR-133 Cookbook for Compiler Writers</a></li>
							<li><a href="https://web.archive.org/web/20220601003130/http://gee.cs.oswego.edu/dl/html/j9mm.html" target="_blank">Using JDK 9 Memory Order Modes</a></li>
						</ul>
					</section>
					<section>
						<h2>References</h2>
						<ul>
							<li><a href="https://github.com/openjdk/jcstress" target="_blank">JCStress</a></li>
							<li><a href="https://shipilev.net/talks/hydraconf-June2021-jcstress-workshop.pdf" target="_blank">JCStress Workshop or, «One Awful Java Concurrency Test After Another»</a></li>
							<li><a href="https://shipilev.net/blog/2016/close-encounters-of-jmm-kind/" target="_blank">Close Encounters of The Java Memory Model Kind</a></li>
							<li><a href="https://shipilev.net/blog/2014/safe-public-construction/" target="_blank" >Safe Publication and Safe Initialization in Java</a></li>
							<li><a href="https://shipilev.net/blog/2014/jmm-pragmatics/" target="_blank">Java Memory Model Pragmatics</a></li>
							<li><a href="https://shipilev.net/jvm/anatomy-quarks/jvm-anatomy-quarks-complete.pdf" target="_blank">JVM Anatomy quarks</a></li>
							<li><a href="https://github.com/reyerizo/jcstress-gradle-plugin" target="_blank">JCStress Gradle plugin</a></li>
						</ul>
					</section>

				</section>
				<section>
					<section>
						<h2>Q & A</h2>
					</section>
				</section>
			</div>
		</div>

		<script src="./reveal.js/dist/reveal.js"></script>
		<script src="./reveal.js/plugin/notes/notes.js"></script>
		<script src="./reveal.js/plugin/markdown/markdown.js"></script>
		<script src="./reveal.js/plugin/highlight/highlight.js"></script>
		<script src="./reveal.js-plugins/embed-tweet/plugin.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				showSlideNumber: 'all',
				slideNumber: 'c/t',
				hash: true,

				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes, RevealEmbedTweet ]
			});
		</script>
	</body>
</html>
